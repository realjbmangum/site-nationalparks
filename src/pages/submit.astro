---
import BaseLayout from '../layouts/BaseLayout.astro';

// Web3Forms access key - stored in Cloudflare Pages env vars
const WEB3FORMS_KEY = import.meta.env.PUBLIC_WEB3FORMS_KEY || 'YOUR_WEB3FORMS_KEY';
---

<BaseLayout
  title="Submit a Tip"
  description="Share your national park knowledge! Submit tips, corrections, or photos to help fellow park visitors."
>
  <div class="section-padding bg-gray-50">
    <div class="container-site">
      <div class="max-w-2xl mx-auto">
        <div class="text-center mb-12">
          <h1 class="text-4xl md:text-5xl font-display font-bold text-gray-900 mb-4">
            Share Your Park Knowledge
          </h1>
          <p class="text-xl text-gray-600">
            Help fellow visitors by sharing tips, corrections, or updates about national parks.
          </p>
        </div>

        <div class="bg-white rounded-xl shadow-md p-8">
          <form id="submit-form" class="space-y-6">
            <input type="hidden" name="access_key" value={WEB3FORMS_KEY} />
            <input type="hidden" name="subject" value="New Park Tip Submission - Best US National Parks" />
            <input type="hidden" name="from_name" value="Best US National Parks Submit Form" />
            <input type="checkbox" name="botcheck" class="hidden" />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                  Your Name *
                </label>
                <input
                  type="text"
                  id="name"
                  name="contact_name"
                  required
                  class="input-field"
                  placeholder="John Doe"
                />
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                  Email Address *
                </label>
                <input
                  type="email"
                  id="email"
                  name="contact_email"
                  required
                  class="input-field"
                  placeholder="john@example.com"
                />
              </div>
            </div>

            <div>
              <label for="park" class="block text-sm font-medium text-gray-700 mb-2">
                Which Park? *
              </label>
              <input
                type="text"
                id="park"
                name="park_name"
                required
                class="input-field"
                placeholder="e.g., Yellowstone, Grand Canyon, Zion"
              />
            </div>

            <div>
              <label for="type" class="block text-sm font-medium text-gray-700 mb-2">
                Submission Type *
              </label>
              <select id="type" name="suggestion_type" required class="input-field">
                <option value="">Select type...</option>
                <option value="tip">Insider Tip</option>
                <option value="correction">Information Correction</option>
                <option value="photo">Photo Suggestion</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 mb-2">
                Your Tip or Correction *
              </label>
              <textarea
                id="message"
                name="message"
                rows="6"
                required
                class="input-field"
                placeholder="Share your knowledge! What should visitors know about this park?"
              ></textarea>
            </div>

            <div class="bg-primary/5 rounded-lg p-4">
              <p class="text-sm text-gray-600">
                <strong>Note:</strong> Submissions are reviewed before being published.
                We may edit for clarity or brevity. By submitting, you grant us permission
                to use your tip on our website.
              </p>
            </div>

            <button type="submit" class="btn-primary w-full" id="submit-btn">
              Submit Tip
            </button>

            <p id="form-message" class="text-center text-sm hidden"></p>
          </form>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('submit-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const formMessage = document.getElementById('form-message') as HTMLParagraphElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    const formData = new FormData(form);

    try {
      // 1. Send to Web3Forms for email notification
      const web3Response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData,
      });

      // 2. Save to Supabase for review
      const { error: supabaseError } = await supabase
        .from('parks_submissions')
        .insert({
          park_name: formData.get('park_name'),
          contact_name: formData.get('contact_name'),
          contact_email: formData.get('contact_email'),
          suggestion_type: formData.get('suggestion_type'),
          message: formData.get('message'),
          status: 'pending',
        });

      if (web3Response.ok) {
        formMessage.textContent = 'Thank you! Your submission has been received and will be reviewed.';
        formMessage.className = 'text-center text-sm text-green-600';
        form.reset();
      } else {
        throw new Error('Failed to submit');
      }
    } catch (error) {
      formMessage.textContent = 'Sorry, something went wrong. Please try again later.';
      formMessage.className = 'text-center text-sm text-red-600';
    } finally {
      formMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Tip';
    }
  });
</script>
