---
import BaseLayout from '../layouts/BaseLayout.astro';
import siteConfig from '../data/site-config.json';

// Web3Forms access key - stored in Cloudflare Pages env vars
const WEB3FORMS_KEY = import.meta.env.PUBLIC_WEB3FORMS_KEY || 'YOUR_WEB3FORMS_KEY';
---

<BaseLayout
  title="Contact Us"
  description="Get in touch with the Best US National Parks team. Questions, feedback, or partnership inquiries welcome."
>
  <div class="section-padding bg-gray-50">
    <div class="container-site">
      <div class="max-w-2xl mx-auto">
        <div class="text-center mb-12">
          <h1 class="text-4xl md:text-5xl font-display font-bold text-gray-900 mb-4">
            Contact Us
          </h1>
          <p class="text-xl text-gray-600">
            Have a question or feedback? We'd love to hear from you.
          </p>
        </div>

        <div class="bg-white rounded-xl shadow-md p-8">
          <form id="contact-form" class="space-y-6">
            <input type="hidden" name="access_key" value={WEB3FORMS_KEY} />
            <input type="hidden" name="subject" value="New Contact Message - Best US National Parks" />
            <input type="hidden" name="from_name" value="Best US National Parks Contact Form" />
            <input type="checkbox" name="botcheck" class="hidden" />

            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                Your Name *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="input-field"
                placeholder="John Doe"
              />
            </div>

            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                Email Address *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="input-field"
                placeholder="john@example.com"
              />
            </div>

            <div>
              <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">
                Subject
              </label>
              <select id="subject" name="message_subject" class="input-field">
                <option value="general">General Question</option>
                <option value="feedback">Feedback</option>
                <option value="correction">Park Information Correction</option>
                <option value="partnership">Partnership Inquiry</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 mb-2">
                Message *
              </label>
              <textarea
                id="message"
                name="message"
                rows="5"
                required
                class="input-field"
                placeholder="How can we help you?"
              ></textarea>
            </div>

            <button type="submit" class="btn-primary w-full" id="submit-btn">
              Send Message
            </button>

            <p id="form-message" class="text-center text-sm hidden"></p>
          </form>
        </div>

        <div class="mt-8 text-center text-gray-600">
          <p>You can also email us directly at:</p>
          <a href={`mailto:${siteConfig.contact.email}`} class="link-primary font-medium">
            {siteConfig.contact.email}
          </a>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const formMessage = document.getElementById('form-message') as HTMLParagraphElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    const formData = new FormData(form);

    try {
      // 1. Send to Web3Forms for email notification
      const web3Response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData,
      });

      // 2. Save to Supabase for record keeping
      const { error: supabaseError } = await supabase
        .from('parks_contact_messages')
        .insert({
          name: formData.get('name'),
          email: formData.get('email'),
          subject: formData.get('message_subject'),
          message: formData.get('message'),
        });

      if (web3Response.ok) {
        formMessage.textContent = 'Thank you! Your message has been sent successfully.';
        formMessage.className = 'text-center text-sm text-green-600';
        form.reset();
      } else {
        throw new Error('Failed to send message');
      }
    } catch (error) {
      formMessage.textContent = 'Sorry, something went wrong. Please try again or email us directly.';
      formMessage.className = 'text-center text-sm text-red-600';
    } finally {
      formMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Message';
    }
  });
</script>
