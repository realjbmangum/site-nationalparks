---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllParks } from '../lib/supabase';

const parks = await getAllParks();

// Convert parks to GeoJSON for Mapbox
const parksGeoJSON = {
  type: 'FeatureCollection',
  features: parks.map(park => ({
    type: 'Feature',
    properties: {
      id: park.id,
      name: park.name,
      slug: park.slug,
      state: park.state,
      difficulty: park.difficulty,
      annual_visitors: park.annual_visitors,
      photo_url: park.photo_url,
      entrance_fee: park.entrance_fee,
    },
    geometry: {
      type: 'Point',
      coordinates: [park.longitude, park.latitude],
    },
  })),
};
---

<BaseLayout
  title="Interactive Map"
  description="Explore all 63 US National Parks on our interactive map. Find parks near you, filter by difficulty, and plan your next adventure."
>
  <div class="h-screen flex flex-col">
    <!-- Header Bar -->
    <div class="bg-white border-b px-4 py-3 flex items-center justify-between z-10 flex-wrap gap-3">
      <div>
        <h1 class="text-xl font-display font-bold text-gray-900">National Parks Map</h1>
        <p class="text-sm text-gray-600">Showing {parks.length} parks</p>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <!-- Map Style Toggle -->
        <div class="flex rounded-lg border overflow-hidden">
          <button id="style-outdoors" class="map-style-btn active px-3 py-1.5 text-sm font-medium">
            Outdoors
          </button>
          <button id="style-satellite" class="map-style-btn px-3 py-1.5 text-sm font-medium border-l">
            Satellite
          </button>
          <button id="style-terrain" class="map-style-btn px-3 py-1.5 text-sm font-medium border-l">
            3D Terrain
          </button>
        </div>
        <!-- Filter Dropdown -->
        <select id="difficulty-filter" class="text-sm border rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-primary">
          <option value="">All Difficulties</option>
          <option value="family">Family Friendly</option>
          <option value="moderate">Moderate</option>
          <option value="challenging">Challenging</option>
          <option value="expert">Expert</option>
        </select>
        <!-- Locate Me Button -->
        <button id="locate-btn" class="flex items-center gap-2 text-sm bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-light transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Near Me
        </button>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map" class="flex-grow relative">
      <!-- Helper Tooltip -->
      <div id="map-helper" class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-gray-900/90 text-white px-4 py-2 rounded-lg text-sm z-10 flex items-center gap-2 shadow-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><strong>Tip:</strong> Right-click + drag to rotate and tilt the map in 3D</span>
        <button id="dismiss-helper" class="ml-2 hover:text-gray-300">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Legend -->
      <div class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-3 z-10">
        <h4 class="text-xs font-semibold text-gray-700 mb-2">Difficulty</h4>
        <div class="space-y-1.5">
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
            <span class="text-xs text-gray-600">Family Friendly</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-amber-500"></span>
            <span class="text-xs text-gray-600">Moderate</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-orange-500"></span>
            <span class="text-xs text-gray-600">Challenging</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-red-500"></span>
            <span class="text-xs text-gray-600">Expert</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
</BaseLayout>

<script define:vars={{ parksGeoJSON, mapboxToken: import.meta.env.PUBLIC_MAPBOX_TOKEN }}>
  // Load Mapbox GL JS
  const script = document.createElement('script');
  script.src = 'https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js';
  script.onload = initMap;
  document.head.appendChild(script);

  let map;
  let currentStyle = 'outdoors';
  const styles = {
    outdoors: 'mapbox://styles/mapbox/outdoors-v12',
    satellite: 'mapbox://styles/mapbox/satellite-streets-v12',
    terrain: 'mapbox://styles/mapbox/outdoors-v12', // We'll add 3D terrain to this
  };

  function initMap() {
    mapboxgl.accessToken = mapboxToken;

    map = new mapboxgl.Map({
      container: 'map',
      style: styles.outdoors,
      center: [-98.5795, 39.8283], // Center of US
      zoom: 3.5,
      pitch: 0,
      bearing: 0,
    });

    // Add controls
    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({ maxWidth: 150 }), 'bottom-right');

    map.on('load', () => {
      addParksLayer();
    });

    // Map style buttons
    document.querySelectorAll('.map-style-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const style = e.target.id.replace('style-', '');
        switchStyle(style);
      });
    });

    // Dismiss helper
    document.getElementById('dismiss-helper')?.addEventListener('click', () => {
      document.getElementById('map-helper').style.display = 'none';
      localStorage.setItem('mapHelperDismissed', 'true');
    });

    // Hide helper if already dismissed
    if (localStorage.getItem('mapHelperDismissed')) {
      document.getElementById('map-helper').style.display = 'none';
    }

    // Difficulty filter
    document.getElementById('difficulty-filter').addEventListener('change', (e) => {
      const difficulty = e.target.value;
      if (map.getLayer('unclustered-point')) {
        if (difficulty) {
          map.setFilter('unclustered-point', ['all', ['!', ['has', 'point_count']], ['==', ['get', 'difficulty'], difficulty]]);
        } else {
          map.setFilter('unclustered-point', ['!', ['has', 'point_count']]);
        }
      }
    });

    // Locate me button
    document.getElementById('locate-btn').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            map.flyTo({
              center: [position.coords.longitude, position.coords.latitude],
              zoom: 6,
              pitch: 45,
            });

            new mapboxgl.Marker({ color: '#F4A300' })
              .setLngLat([position.coords.longitude, position.coords.latitude])
              .setPopup(new mapboxgl.Popup().setHTML('<p class="font-medium p-2">You are here</p>'))
              .addTo(map);
          },
          (error) => {
            alert('Could not get your location. Please enable location services.');
          }
        );
      } else {
        alert('Geolocation is not supported by your browser.');
      }
    });
  }

  function switchStyle(style) {
    currentStyle = style;

    // Update button states
    document.querySelectorAll('.map-style-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.getElementById(`style-${style}`).classList.add('active');

    // Switch map style
    map.setStyle(styles[style]);

    // Re-add layers after style change
    map.once('style.load', () => {
      addParksLayer();

      // Add 3D terrain for terrain view
      if (style === 'terrain') {
        map.addSource('mapbox-dem', {
          type: 'raster-dem',
          url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
          tileSize: 512,
          maxzoom: 14,
        });
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });

        // Add sky layer for better 3D effect
        map.addLayer({
          id: 'sky',
          type: 'sky',
          paint: {
            'sky-type': 'atmosphere',
            'sky-atmosphere-sun': [0.0, 90.0],
            'sky-atmosphere-sun-intensity': 15,
          },
        });

        // Tilt the map for 3D view
        map.easeTo({ pitch: 60, bearing: -20, duration: 1000 });
      } else {
        // Reset pitch for 2D views
        map.easeTo({ pitch: 0, bearing: 0, duration: 500 });
      }
    });
  }

  function addParksLayer() {
    // Add parks source
    map.addSource('parks', {
      type: 'geojson',
      data: parksGeoJSON,
      cluster: true,
      clusterMaxZoom: 6,
      clusterRadius: 50,
    });

    // Cluster circles
    map.addLayer({
      id: 'clusters',
      type: 'circle',
      source: 'parks',
      filter: ['has', 'point_count'],
      paint: {
        'circle-color': '#1E4D2B',
        'circle-radius': ['step', ['get', 'point_count'], 20, 10, 30, 25, 40],
        'circle-stroke-width': 2,
        'circle-stroke-color': '#fff',
      },
    });

    // Cluster count labels
    map.addLayer({
      id: 'cluster-count',
      type: 'symbol',
      source: 'parks',
      filter: ['has', 'point_count'],
      layout: {
        'text-field': ['get', 'point_count_abbreviated'],
        'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
        'text-size': 14,
      },
      paint: {
        'text-color': '#ffffff',
      },
    });

    // Individual park markers
    map.addLayer({
      id: 'unclustered-point',
      type: 'circle',
      source: 'parks',
      filter: ['!', ['has', 'point_count']],
      paint: {
        'circle-color': [
          'match',
          ['get', 'difficulty'],
          'family', '#2563EB',
          'moderate', '#D97706',
          'challenging', '#EA580C',
          'expert', '#DC2626',
          '#1E4D2B',
        ],
        'circle-radius': 10,
        'circle-stroke-width': 2,
        'circle-stroke-color': '#fff',
      },
    });

    // Click on cluster to zoom
    map.on('click', 'clusters', (e) => {
      const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
      const clusterId = features[0].properties.cluster_id;
      map.getSource('parks').getClusterExpansionZoom(clusterId, (err, zoom) => {
        if (err) return;
        map.easeTo({
          center: features[0].geometry.coordinates,
          zoom: zoom,
        });
      });
    });

    // Click on park marker to show popup
    map.on('click', 'unclustered-point', (e) => {
      const props = e.features[0].properties;
      const coords = e.features[0].geometry.coordinates.slice();

      const difficultyColors = {
        family: 'bg-blue-500',
        moderate: 'bg-amber-500',
        challenging: 'bg-orange-500',
        expert: 'bg-red-500',
      };

      const difficultyLabels = {
        family: 'Family Friendly',
        moderate: 'Moderate',
        challenging: 'Challenging',
        expert: 'Expert',
      };

      const visitors = props.annual_visitors >= 1000000
        ? `${(props.annual_visitors / 1000000).toFixed(1)}M`
        : `${Math.round(props.annual_visitors / 1000)}K`;

      const html = `
        <div class="p-1 max-w-[250px]">
          ${props.photo_url ? `<img src="${props.photo_url}" alt="${props.name}" class="w-full h-32 object-cover rounded-lg mb-2" />` : ''}
          <h3 class="font-bold text-gray-900">${props.name}</h3>
          <p class="text-sm text-gray-600 mb-2">${props.state}</p>
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs px-2 py-1 rounded-full text-white ${difficultyColors[props.difficulty] || 'bg-green-700'}">
              ${difficultyLabels[props.difficulty] || 'Moderate'}
            </span>
            <span class="text-xs text-gray-500">${visitors} visitors/yr</span>
          </div>
          <a href="/parks/${props.slug}" class="text-sm text-primary hover:underline font-medium">View Park Details â†’</a>
        </div>
      `;

      new mapboxgl.Popup({ offset: 15, maxWidth: '280px' })
        .setLngLat(coords)
        .setHTML(html)
        .addTo(map);
    });

    // Cursor changes
    map.on('mouseenter', 'clusters', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'clusters', () => map.getCanvas().style.cursor = '');
    map.on('mouseenter', 'unclustered-point', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'unclustered-point', () => map.getCanvas().style.cursor = '');
  }
</script>

<style>
  .mapboxgl-popup-content {
    padding: 0;
    border-radius: 12px;
    overflow: hidden;
  }
  .mapboxgl-popup-close-button {
    font-size: 18px;
    padding: 4px 8px;
  }
  .map-style-btn {
    background: white;
    color: #374151;
    transition: all 0.2s;
  }
  .map-style-btn:hover {
    background: #f3f4f6;
  }
  .map-style-btn.active {
    background: #1E4D2B;
    color: white;
  }
</style>
